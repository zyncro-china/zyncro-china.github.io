<html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
<title>notes for programming elixir concurrent programming</title>
<meta content='' name='description'>
<meta content='width=device-width' name='viewport'>
<link href='/css/normalize.css' rel='stylesheet'>
<link href='/css/main.css' rel='stylesheet'>
<link href='/css/bootstrap.min.css' rel='stylesheet'>
<link href='/stylesheets/background.css' rel='stylesheet'>
<link href='/stylesheets/article.css' rel='stylesheet'>
<script src='/js/vendor/modernizr-2.6.1.min.js'></script>
<script src='/js/vendor/jquery-1.8.0.min.js'></script>
<script src='/js/bootstrap.min.js'></script>
<link href="/stylesheets/rouge.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/home.css" media="screen" rel="stylesheet" type="text/css" />
</head>
<body>
<header>
<nav class='navbar navbar-default' role='navigation'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-ex1-collapse' data-toggle='collapse' type='button'>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</button>
<a class='navbar-brand'></a>
</div>
<div class='collapse navbar-collapse navbar-ex1-collapse'>
<ul class='nav navbar-nav'>
<li>
<a href='/'>Home</a>
</li>
<li>
<a href='/feed.xml'>Feed</a>
</li>
<li>
<a href='/about'>About</a>
</li>
</ul>
</div>
</nav>
</header>
<section class='main'>
<div id='main' role='main'>
<div class='container'>
<article>
<div class='title'>
<h1 class='page-header text-center'>
notes for programming elixir concurrent programming
</h1>
</div>
<br>
<h2>part II concurrent programming的内容</h2>

<ol>
<li><a href="#working_with_multiple_processes">Working With Multiple Processes</a></li>
<li><a href="#nodes_the_key_to_distrbuting_services">Nodes The Key To Distrbuting Services</a></li>
<li><a href="#otp_servers">OTP Servers</a></li>
<li><a href="#otp_supervisors">OTP Supervisors</a></li>
<li><a href="#otp_applications">OTP Applications</a></li>
<li><a href="#tasks_and_agents">Tasks and Agents</a></li>
</ol>

<h2>part III More Advanced Elixir的内容</h2>

<ol>
<li><a href="#macros_and_code_evaluation">Macros And Code Evaluation</a></li>
<li><a href="#protocols_polymorphic_functions">Protocols Polymorphic Functions</a></li>
<li><a href="#linking_modules_behaviours_and_use">Linking Modules Behaviours and Use</a></li>
<li><a href="#more_cool_stuff">More Cool Stuff</a></li>
</ol>

<p><a name="working_with_multiple_processes"></a></p>

<h2>Working With Multiple Processes</h2>

<p>Elixir使用Actor模型，一个actor就是一个独立的进程，你可以spawn一个进程，可以发消息给进程，也可以接收消息。</p>

<p>注意，下面的代码无法做尾递归优化，有可能会堆栈溢出</p>
<pre class="highlight elixir"><span class="k">def</span> <span class="n">factorial</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="m">1</span>
<span class="k">def</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="n">n</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="m">1</span><span class="p">)</span>
</pre>
<p>用进程做计数器的例子</p>
<pre class="highlight elixir">
<span class="k">defmodule</span> <span class="no">Chain</span> <span class="k">do
  def</span> <span class="n">count</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="k">do
    receive</span> <span class="k">do
      </span><span class="n">n</span> <span class="o">-&gt;</span>
        <span class="n">send</span> <span class="n">pid</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="m">1</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">create_processes</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">do
    </span><span class="n">last</span> <span class="o">=</span> <span class="no">Enum</span><span class="o">.</span><span class="n">reduce</span> <span class="m">1</span><span class="o">..</span><span class="n">n</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="k">fn</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">last_pid</span><span class="p">)</span><span class="o">-&gt;</span>
      <span class="n">spawn</span><span class="p">(</span><span class="no">Chain</span><span class="p">,</span> <span class="ss">:count</span><span class="p">,</span> <span class="p">[</span><span class="n">last_pid</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="n">send</span> <span class="n">last</span><span class="p">,</span> <span class="m">0</span>

    <span class="k">receive</span> <span class="k">do
      </span><span class="n">n</span> <span class="o">-&gt;</span> <span class="sd">&quot;</span><span class="s2">Result is </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">run</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">do
    </span><span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="n">inspect</span> <span class="ss">:timer</span><span class="o">.</span><span class="n">tc</span><span class="p">(</span><span class="no">Chain</span><span class="p">,</span> <span class="ss">:create_processes</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Chain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="m">100_000</span><span class="p">)</span>

</pre>
<p>{633040, &ldquo;Result is 100000&rdquo;}</p>

<p>100,000个进程需要633ms</p>

<h3>连接2个进程</h3>

<p>用spawn_link</p>

<h3>监视进程</h3>

<p>用Process.spawn_monitor</p>

<h3>Parallel Map</h3>
<pre class="highlight elixir"><span class="k">defmodule</span> <span class="no">Parallel</span> <span class="k">do
  def</span> <span class="n">pmap</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">fun</span><span class="p">)</span> <span class="k">do
    </span><span class="n">me</span> <span class="o">=</span> <span class="n">self</span>
    <span class="n">collection</span>
    <span class="o">|&gt;</span>
    <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="n">spawn_link</span> <span class="k">fn</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">send</span> <span class="n">me</span><span class="p">,</span> <span class="p">{</span> <span class="n">self</span><span class="p">,</span> <span class="n">fun</span><span class="o">.</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="p">})</span> <span class="k">end</span>
    <span class="k">end</span><span class="p">)</span>
    <span class="o">|&gt;</span>
    <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="k">receive</span> <span class="k">do </span><span class="p">{</span> <span class="o">^</span><span class="n">pid</span><span class="p">,</span> <span class="n">result</span> <span class="p">}</span> <span class="o">-&gt;</span> <span class="n">result</span> <span class="k">end</span>
    <span class="k">end</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">iex</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">(</span><span class="sd">&quot;</span><span class="s2">pmap.exs&quot;</span><span class="p">)</span>
<span class="p">[</span><span class="no">Parallel</span><span class="p">]</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Parallel</span><span class="o">.</span><span class="n">pmap</span> <span class="m">1</span><span class="o">..</span><span class="m">10</span><span class="p">,</span> <span class="err">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span> <span class="o">*</span> <span class="nv">&amp;1</span><span class="p">)</span>
<span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">9</span><span class="p">,</span><span class="m">16</span><span class="p">,</span><span class="m">25</span><span class="p">,</span><span class="m">36</span><span class="p">,</span><span class="m">49</span><span class="p">,</span><span class="m">64</span><span class="p">,</span><span class="m">81</span><span class="p">,</span><span class="m">100</span><span class="p">]</span>
</pre>
<h3>Fibonacci Server</h3>
<pre class="highlight elixir"><span class="c1"># fib.exs</span>
<span class="k">defmodule</span> <span class="no">FibSolver</span> <span class="k">do
  def</span> <span class="n">fib</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span> <span class="k">do
    </span><span class="n">send</span> <span class="n">scheduler</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:ready</span><span class="p">,</span> <span class="n">self</span> <span class="p">}</span>
    <span class="k">receive</span> <span class="k">do
      </span><span class="p">{</span> <span class="ss">:fib</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">client</span> <span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">send</span> <span class="n">client</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:answer</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fib_calc</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">self</span> <span class="p">}</span> <span class="n">fib</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
      <span class="p">{</span> <span class="ss">:shutdown</span> <span class="p">}</span> <span class="o">-&gt;</span>
        <span class="k">exit</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># very inefficient, deliberately</span>
  <span class="k">defp</span> <span class="n">fib_calc</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="m">1</span>
  <span class="k">defp</span> <span class="n">fib_calc</span><span class="p">(</span><span class="m">1</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="m">1</span>
  <span class="k">defp</span> <span class="n">fib_calc</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="n">fib_calc</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib_calc</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="m">2</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">defmodule</span> <span class="no">Scheduler</span> <span class="k">do
  def</span> <span class="n">run</span><span class="p">(</span><span class="n">num_processes</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">to_calculate</span><span class="p">)</span> <span class="k">do
    </span><span class="p">(</span><span class="m">1</span><span class="o">..</span><span class="n">num_processes</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spawn</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">])</span> <span class="k">end</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">schedule_processes</span><span class="p">(</span><span class="n">to_calculate</span><span class="p">,</span> <span class="p">[])</span>
  <span class="k">end</span>
  <span class="k">defp</span> <span class="n">schedule_processes</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span> <span class="k">do
    receive</span> <span class="k">do
      </span><span class="p">{</span><span class="ss">:ready</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="ow">when</span> <span class="n">length</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">-&gt;</span>
        <span class="p">[</span> <span class="n">next</span> <span class="o">|</span> <span class="n">tail</span> <span class="p">]</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="n">send</span> <span class="n">pid</span><span class="p">,</span> <span class="p">{</span><span class="ss">:fib</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">self</span><span class="p">}</span>
        <span class="n">schedule_processes</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
      <span class="p">{</span><span class="ss">:ready</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">send</span> <span class="n">pid</span><span class="p">,</span> <span class="p">{</span><span class="ss">:shutdown</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">length</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span> <span class="k">do
          </span><span class="n">schedule_processes</span><span class="p">(</span><span class="no">List</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="n">queue</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="no">Enum</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="k">fn</span> <span class="p">{</span><span class="n">n1</span><span class="p">,</span><span class="n">_</span><span class="p">},</span> <span class="p">{</span><span class="n">n2</span><span class="p">,</span><span class="n">_</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">n1</span> <span class="o">&lt;=</span> <span class="n">n2</span> <span class="k">end</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="p">{</span><span class="ss">:answer</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">_pid</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">schedule_processes</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="p">[</span> <span class="p">{</span><span class="n">number</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">|</span> <span class="n">results</span> <span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">to_process</span> <span class="o">=</span> <span class="p">[</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">37</span> <span class="p">]</span>
<span class="no">Enum</span><span class="o">.</span><span class="n">each</span> <span class="m">1</span><span class="o">..</span><span class="m">10</span><span class="p">,</span> <span class="k">fn</span> <span class="n">num_processes</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">time</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:timer</span><span class="o">.</span><span class="n">tc</span><span class="p">(</span><span class="no">Scheduler</span><span class="p">,</span> <span class="ss">:run</span><span class="p">,</span>
    <span class="p">[</span><span class="n">num_processes</span><span class="p">,</span> <span class="no">FibSolver</span><span class="p">,</span> <span class="ss">:fib</span><span class="p">,</span> <span class="n">to_process</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">num_processes</span> <span class="o">==</span> <span class="m">1</span> <span class="k">do
    </span><span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="n">inspect</span> <span class="n">result</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">&quot;</span><span class="s2">\n </span><span class="err">#</span><span class="s2">
    time (s)&quot;</span>
  <span class="k">end</span>
  <span class="ss">:io</span><span class="o">.</span><span class="n">format</span> <span class="sd">&quot;</span><span class="s2">~2B     ~.2f~n&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">num_processes</span><span class="p">,</span> <span class="n">time</span><span class="o">/</span><span class="m">1000000.0</span><span class="p">]</span>
<span class="k">end</span>
</pre><pre class="highlight elixir"><span class="err">$</span> <span class="n">elixir</span> <span class="n">fib</span><span class="o">.</span><span class="n">exs</span>
<span class="p">[{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span> <span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span> <span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span> <span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span>
<span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span> <span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span> <span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span> <span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span>
<span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">},</span> <span class="p">{</span><span class="m">37</span><span class="p">,</span> <span class="m">39088169</span><span class="p">}]</span>
<span class="c1">#    time (s)</span>
<span class="m">1</span>    <span class="m">10.64</span>
<span class="m">2</span>    <span class="m">6.05</span>
<span class="m">3</span>    <span class="m">5.67</span>
<span class="m">4</span>    <span class="m">4.97</span>
<span class="m">5</span>    <span class="m">4.79</span>
<span class="m">6</span>    <span class="m">5.28</span>
<span class="m">7</span>    <span class="m">5.47</span>
<span class="m">8</span>    <span class="m">5.24</span>
<span class="m">9</span>    <span class="m">5.29</span>
<span class="m">10</span>   <span class="m">5.20</span>
</pre>
<h3>Agents</h3>

<p>module只是function的容器，为了能存储state，使用agent module</p>
<pre class="highlight elixir"><span class="k">defmodule</span> <span class="no">FibAgent</span> <span class="k">do
  def</span> <span class="n">start_link</span> <span class="k">do
    </span><span class="n">cache</span> <span class="o">=</span> <span class="no">Enum</span><span class="o">.</span><span class="n">into</span><span class="p">([{</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">},</span> <span class="p">{</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">}],</span> <span class="no">HashDict</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
    <span class="no">Agent</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">cache</span> <span class="k">end</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="n">fib</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">when</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="k">do
    </span><span class="no">Agent</span><span class="o">.</span><span class="n">get_and_update</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="err">&amp;</span><span class="n">do_fib</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
  <span class="k">end</span>
  <span class="k">defp</span> <span class="n">do_fib</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">do
    if</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">do
      </span><span class="p">{</span><span class="n">cached</span><span class="p">,</span> <span class="n">cache</span><span class="p">}</span>
    <span class="k">else</span>
      <span class="p">{</span><span class="n">val</span><span class="p">,</span> <span class="n">cache</span><span class="p">}</span> <span class="o">=</span> <span class="n">do_fib</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="m">2</span><span class="p">]</span>
      <span class="p">{</span><span class="n">result</span><span class="p">,</span> <span class="no">Dict</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span><span class="p">)}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">agent</span><span class="p">}</span> <span class="o">=</span> <span class="no">FibAgent</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
<span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="no">FibAgent</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="m">2000</span><span class="p">)</span>
</pre>
<p><a name="nodes_the_key_to_distrbuting_services"></a></p>

<h2>Nodes</h2>

<p><a href="http://elixir-lang.org/docs/stable/elixir/Node.html">Node Module API</a></p>

<h3>Naming Nodes</h3>
<pre class="highlight elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">self</span>
<span class="ss">:nonode</span><span class="nv">@nohost</span>

<span class="err">$</span> <span class="n">iex</span> <span class="o">--</span><span class="n">name</span> <span class="n">wibble</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="o">.</span><span class="n">local</span>
<span class="n">iex</span><span class="p">(</span><span class="n">wibble</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="o">.</span><span class="n">local</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">self</span>
<span class="ss">:&quot;wibble@light-boy.local&quot;</span>

<span class="err">$</span> <span class="n">iex</span> <span class="o">--</span><span class="n">sname</span> <span class="n">wobble</span>
<span class="n">iex</span><span class="p">(</span><span class="n">wobble</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">self</span>
<span class="ss">:&quot;wobble@light-boy&quot;</span>

</pre>
<p>Connect nodes:</p>
<pre class="highlight elixir"><span class="c1">#Window #1</span>
<span class="err">$</span> <span class="n">iex</span> <span class="o">--</span><span class="n">sname</span> <span class="n">node_one</span>
<span class="n">iex</span><span class="p">(</span><span class="n">node_one</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span><span class="o">&gt;</span>

<span class="c1">#Window #2</span>
<span class="err">$</span> <span class="n">iex</span> <span class="o">--</span><span class="n">sname</span> <span class="n">node_two</span>
<span class="n">iex</span><span class="p">(</span><span class="n">node_two</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">list</span>
<span class="p">[]</span>
<span class="n">iex</span><span class="p">(</span><span class="n">node_two</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">connect</span> <span class="ss">:&quot;node_one@light-boy&quot;</span>
<span class="no">true</span>
<span class="n">iex</span><span class="p">(</span><span class="n">node_two</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">list</span>
<span class="p">[</span><span class="ss">:&quot;node_one@light-boy&quot;</span><span class="p">]</span>
</pre>
<p>spawn可以在其他node上运行</p>
<pre class="highlight elixir"><span class="n">iex</span><span class="p">(</span><span class="n">node_one</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">func</span> <span class="o">=</span> <span class="k">fn</span> <span class="o">-&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span> <span class="no">Node</span><span class="o">.</span><span class="n">self</span> <span class="k">end</span>
<span class="c1">#Function&lt;erl_eval.20.82930912&gt;</span>

<span class="n">iex</span><span class="p">(</span><span class="n">node_one</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="ss">:&quot;node_two@light-boy&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
<span class="c1">#PID&lt;7393.48.0&gt;</span>
<span class="n">node_two</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span>
</pre>
<p>由于spawn继承了进程的结构，包括group leader,这决定了IO.puts往哪里输出，所以还是在node_one上看到输出</p>

<h3>Cookies</h3>

<p>使用cookie来允许node的连接</p>
<pre class="highlight elixir"><span class="err">$</span> <span class="n">iex</span> <span class="o">--</span><span class="n">sname</span> <span class="n">one</span> <span class="o">--</span><span class="n">cookie</span> <span class="n">chocolate</span><span class="o">-</span><span class="n">chip</span>
<span class="n">iex</span><span class="p">(</span><span class="n">one</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">get_cookie</span>
<span class="ss">:&quot;chocolate-chip&quot;</span>
</pre>
<h3>Naming Your Processes</h3>

<p>使用:global.register_name,和:global.whereis_name</p>
<pre class="highlight elixir"><span class="k">defmodule</span> <span class="no">Tick</span> <span class="k">do
  </span><span class="c1"># 2 seconds</span>
  <span class="nv">@interval</span> <span class="m">2000</span>
  <span class="nv">@name</span> <span class="ss">:ticker</span>
  <span class="k">def</span> <span class="n">start</span> <span class="k">do
    </span><span class="n">pid</span> <span class="o">=</span> <span class="n">spawn</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="ss">:generator</span><span class="p">,</span> <span class="p">[[]])</span>
    <span class="ss">:global</span><span class="o">.</span><span class="n">register_name</span><span class="p">(</span><span class="nv">@name</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="n">register</span><span class="p">(</span><span class="n">client_pid</span><span class="p">)</span> <span class="k">do
    </span><span class="n">send</span> <span class="ss">:global</span><span class="o">.</span><span class="n">whereis_name</span><span class="p">(</span><span class="nv">@name</span><span class="p">),</span> <span class="p">{</span> <span class="ss">:register</span><span class="p">,</span> <span class="n">client_pid</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="n">generator</span><span class="p">(</span><span class="n">clients</span><span class="p">)</span> <span class="k">do
    receive</span> <span class="k">do
      </span><span class="p">{</span> <span class="ss">:register</span><span class="p">,</span> <span class="n">pid</span> <span class="p">}</span> <span class="o">-&gt;</span>
        <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">&quot;</span><span class="s2">registering </span><span class="si">#{</span><span class="n">inspect</span> <span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">generator</span><span class="p">([</span><span class="n">pid</span><span class="o">|</span><span class="n">clients</span><span class="p">])</span>
    <span class="k">after</span>
      <span class="nv">@interval</span> <span class="o">-&gt;</span>
        <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">&quot;</span><span class="s2">tick&quot;</span>
        <span class="no">Enum</span><span class="o">.</span><span class="n">each</span> <span class="n">clients</span><span class="p">,</span> <span class="k">fn</span> <span class="n">client</span> <span class="o">-&gt;</span>
          <span class="n">send</span> <span class="n">client</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:tick</span> <span class="p">}</span>
        <span class="k">end</span>
        <span class="n">generator</span><span class="p">(</span><span class="n">clients</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">defmodule</span> <span class="no">Client</span> <span class="k">do
  def</span> <span class="n">start</span> <span class="k">do
    </span><span class="n">pid</span> <span class="o">=</span> <span class="n">spawn</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="ss">:receiver</span><span class="p">,</span> <span class="p">[])</span>
    <span class="no">Tick</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="n">receiver</span> <span class="k">do
    receive</span> <span class="k">do
      </span><span class="p">{</span> <span class="ss">:tick</span> <span class="p">}</span> <span class="o">-&gt;</span>
        <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">&quot;</span><span class="s2">tock in client&quot;</span>
        <span class="n">receiver</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<h3>I/O, PIDS, and Nodes</h3>
<pre class="highlight elixir"><span class="c1"># window #2</span>
<span class="err">$</span> <span class="n">iex</span> <span class="o">--</span><span class="n">sname</span> <span class="n">two</span>
<span class="n">iex</span><span class="p">(</span><span class="n">two</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="ss">:&quot;one@light-boy&quot;</span><span class="p">)</span>
<span class="no">true</span>
<span class="n">iex</span><span class="p">(</span><span class="n">two</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="ss">:global</span><span class="o">.</span><span class="n">register_name</span><span class="p">(</span><span class="ss">:two</span><span class="p">,</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">group_leader</span><span class="p">)</span>
<span class="ss">:yes</span>

<span class="c1"># window #1</span>
<span class="n">iex</span><span class="p">(</span><span class="n">one</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">two</span> <span class="o">=</span> <span class="ss">:global</span><span class="o">.</span><span class="n">whereis_name</span> <span class="ss">:two</span>
<span class="c1">#PID&lt;7419.30.0&gt;</span>
<span class="n">iex</span><span class="p">(</span><span class="n">one</span><span class="nv">@light</span><span class="o">-</span><span class="n">boy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="n">two</span><span class="p">,</span> <span class="sd">&quot;</span><span class="s2">Hello&quot;</span><span class="p">)</span>
<span class="c1">#将会在window #2看到输出</span>
</pre>
<p><a name="otp_servers"></a></p>

<h2>OTP Servers</h2>

<p>OTP用application的结构定义系统。
一个application由一个或多个进程组成。这些进程跟随一小部分OTP惯例(behavior)。</p>

<ol>
<li>general purpose servers</li>
<li>event handler</li>
<li>FSM</li>
</ol>

<p>这些behavior的实现都在自己的进程里运行。</p>

<p>还有一个特别的behavior: supervisor。</p>

<p>实现OTP server时，只需写一个包含其callback的module，OTP会根据需要调用适当的callback</p>
<pre class="highlight elixir"><span class="k">defmodule</span> <span class="no">Sequence</span><span class="o">.</span><span class="no">Server</span> <span class="k">do
  </span><span class="kn">use</span> <span class="no">GenServer</span>
  <span class="c1"># handle_call的3个参数是client传来的参数，client的pid，server的状态</span>
  <span class="k">def</span> <span class="n">handle_call</span><span class="p">(</span><span class="ss">:next_number</span><span class="p">,</span> <span class="n">_from</span><span class="p">,</span> <span class="n">current_number</span><span class="p">)</span> <span class="k">do
    </span><span class="c1"># 函数最后返回的是3元组 :reply表示返回给client， 返回值，server的最新状态</span>
    <span class="p">{</span> <span class="ss">:reply</span><span class="p">,</span> <span class="n">current_number</span><span class="p">,</span> <span class="n">current_number</span><span class="o">+</span><span class="m">1</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre>
<p>Client只需要知道server的pid，就可以用GenServer.call发消息给server</p>

<p>GenServer.start_link接受2个参数: server module和初始状态</p>
<pre class="highlight elixir"><span class="err">$</span> <span class="n">iex</span> <span class="o">-</span><span class="no">S</span> <span class="n">mix</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="p">{</span> <span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span> <span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Sequence</span><span class="o">.</span><span class="no">Server</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="c1">#PID&lt;0.71.0&gt;}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="m">100</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="m">101</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="m">102</span>
</pre>
<p>如果不需返回值，就用handle_cast</p>
<pre class="highlight text">
def handle_cast({:increment_number, delta}, current_number) do
  {:noreply, current_number + delta}
end

iex&gt; GenServer.call(pid, :next_number)
101
iex&gt; GenServer.cast(pid, {:increment_number, 200})
:ok
iex&gt; GenServer.call(pid, :next_number)
302
</pre>
<h3>Tracing</h3>

<p>start_link第3个参数是options</p>
<pre class="highlight elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Sequence</span><span class="o">.</span><span class="no">Server</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="p">[</span><span class="ss">debug:</span> <span class="p">[</span><span class="ss">:trace</span><span class="p">]])</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="c1">#PID&lt;0.68.0&gt;}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="o">*</span><span class="no">DBG</span><span class="o">*</span> <span class="o">&lt;</span><span class="m">0.68</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span> <span class="n">got</span> <span class="n">call</span> <span class="n">next_number</span> <span class="n">from</span> <span class="o">&lt;</span><span class="m">0.25</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span>
<span class="o">*</span><span class="no">DBG</span><span class="o">*</span> <span class="o">&lt;</span><span class="m">0.68</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span> <span class="n">sent</span> <span class="m">100</span> <span class="n">to</span> <span class="o">&lt;</span><span class="m">0.25</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">new</span> <span class="n">state</span> <span class="m">101</span>
<span class="m">100</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="o">*</span><span class="no">DBG</span><span class="o">*</span> <span class="o">&lt;</span><span class="m">0.68</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span> <span class="n">got</span> <span class="n">call</span> <span class="n">next_number</span> <span class="n">from</span> <span class="o">&lt;</span><span class="m">0.25</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span>
<span class="o">*</span><span class="no">DBG</span><span class="o">*</span> <span class="o">&lt;</span><span class="m">0.68</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span> <span class="n">sent</span> <span class="m">101</span> <span class="n">to</span> <span class="o">&lt;</span><span class="m">0.25</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">new</span> <span class="n">state</span> <span class="m">102</span>
<span class="m">101</span>

<span class="n">iex</span><span class="o">&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Sequence</span><span class="o">.</span><span class="no">Server</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="p">[</span><span class="ss">debug:</span> <span class="p">[</span><span class="ss">:statistics</span><span class="p">]])</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="c1">#PID&lt;0.69.0&gt;}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="m">100</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="m">101</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:sys</span><span class="o">.</span><span class="n">statistics</span> <span class="n">pid</span><span class="p">,</span> <span class="ss">:get</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,[</span><span class="ss">start_time:</span> <span class="p">{{</span><span class="m">2013</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">26</span><span class="p">},{</span><span class="m">18</span><span class="p">,</span><span class="m">17</span><span class="p">,</span><span class="m">16</span><span class="p">}},</span> <span class="ss">current_time:</span> <span class="p">{{</span><span class="m">2013</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">26</span><span class="p">},{</span><span class="m">18</span><span class="p">,</span><span class="m">17</span><span class="p">,</span><span class="m">28</span><span class="p">}},</span>
<span class="ss">reductions:</span> <span class="m">50</span><span class="p">,</span> <span class="ss">messages_in:</span> <span class="m">2</span><span class="p">,</span> <span class="ss">messages_out:</span> <span class="m">0</span><span class="p">]}</span>
</pre>
<p>:debug 参数的值是列表，里面的值是Erlang sys module的函数名字。
<a href="http://www.erlang.org/doc/man/sys.html">http://www.erlang.org/doc/man/sys.html</a></p>

<p>可以在启动server后打开关闭tracing</p>
<pre class="highlight elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:sys</span><span class="o">.</span><span class="n">trace</span> <span class="n">pid</span><span class="p">,</span> <span class="no">true</span>
<span class="ss">:ok</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="o">*</span><span class="no">DBG</span><span class="o">*</span> <span class="o">&lt;</span><span class="m">0.69</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span> <span class="n">got</span> <span class="n">call</span> <span class="n">next_number</span> <span class="n">from</span> <span class="o">&lt;</span><span class="m">0.25</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span>
<span class="o">*</span><span class="no">DBG</span><span class="o">*</span> <span class="o">&lt;</span><span class="m">0.69</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span> <span class="n">sent</span> <span class="m">105</span> <span class="n">to</span> <span class="o">&lt;</span><span class="m">0.25</span><span class="o">.</span><span class="m">0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">new</span> <span class="n">state</span> <span class="m">106</span> <span class="m">105</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:sys</span><span class="o">.</span><span class="n">trace</span> <span class="n">pid</span><span class="p">,</span> <span class="no">false</span>
<span class="ss">:ok</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="m">106</span>
<span class="c1">#Another useful sys function is get_status</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:sys</span><span class="o">.</span><span class="n">get_status</span> <span class="n">pid</span>
<span class="p">{</span><span class="ss">:status</span><span class="p">,</span><span class="c1">#PID&lt;0.57.0&gt;,{:module,:gen_server},[[&quot;$ancestors&quot;: [#PID&lt;0.25.0&gt;],</span>
<span class="sd">&quot;</span><span class="s2">$initial_call&quot;</span><span class="p">:</span>
<span class="p">{</span><span class="no">Sequence</span><span class="o">.</span><span class="no">Server</span><span class="p">,</span><span class="ss">:init</span><span class="p">,</span><span class="m">1</span><span class="p">}],</span><span class="ss">:running</span><span class="p">,</span><span class="c1">#PID&lt;0.25.0&gt;,[],</span>
<span class="p">[</span><span class="ss">header:</span> <span class="s1">&#39;Status for generic server &lt;0.57.0&gt;&#39;</span><span class="p">,</span>
<span class="ss">data:</span> <span class="p">[{</span><span class="s1">&#39;Status&#39;</span><span class="p">,</span><span class="ss">:running</span><span class="p">},{</span><span class="s1">&#39;Parent&#39;</span><span class="p">,</span><span class="c1">#PID&lt;0.25.0&gt;},{&#39;Logged events&#39;,[]}],</span>
<span class="ss">data:</span> <span class="p">[{</span><span class="s1">&#39;State&#39;</span><span class="p">,</span><span class="m">102</span><span class="p">}]]]}</span>
</pre>
<h3>GenServer Callbacks</h3>

<ol>
<li>init(start_arguments)</li>
<li>handle_call(request, from, state)</li>
<li>handle_cast(request, state)</li>
<li>handle_info(info, state)</li>
<li>terminate(reason, state)</li>
<li>code_change(from_version, state, extra)</li>
<li>format_status(reason, [pdict, state])</li>
</ol>

<h3>Naming</h3>
<pre class="highlight elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="p">{</span> <span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span> <span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(,</span> <span class="no">Sequence</span><span class="o">.</span><span class="no">Server</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="ss">name:</span> <span class="ss">:seq</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="c1">#PID&lt;0.66.0&gt;}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="ss">:seq</span><span class="p">,</span> <span class="ss">:next_number</span><span class="p">)</span>
<span class="m">100</span>
</pre>
<h3>Tidying up the interface</h3>

<p>client必须知道GenServer，还要知道pid，应该把这些信息都封装好</p>
<pre class="highlight elixir"><span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">current_number</span><span class="p">)</span> <span class="k">do
  </span><span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="n">current_number</span><span class="p">,</span> <span class="ss">name:</span> <span class="bp">__MODULE__</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">next_number</span> <span class="k">do
  </span><span class="no">GenServer</span><span class="o">.</span><span class="n">call</span> <span class="bp">__MODULE__</span><span class="p">,</span> <span class="ss">:next_number</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">increment_number</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="k">do
  </span><span class="no">GenServer</span><span class="o">.</span><span class="n">cast</span> <span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">{</span><span class="ss">:increment_number</span><span class="p">,</span> <span class="n">delta</span><span class="p">}</span>
<span class="k">end</span>
</pre>
<p>Genserver behavior定义了一个内部的message loop,maintain了一个state变量，然后message loop 调用module里定义的几个函数，如handle_call, handle_cast</p>

<p><a name="otp_supervisors"></a></p>

<h2>OTP Supervisors</h2>

<p><a name="otp_applications"></a></p>

<h2>OTP Applications</h2>

<p><a name="tasks_and_agents"></a></p>

<h2>Tasks and Agents</h2>

</article>
<div id="disqus_thread"></div>
            <script type="text/javascript">
            //<![CDATA[
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//zyncrochinadevblog.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            //]]>
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </script>

</div>
</div>
</section>
<footer>
<script type="text/javascript">
//<![CDATA[
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44086232-1', 'zyncro-china.com');
  ga('send', 'pageview');
//]]>
</script>
</footer>
</body>
</html>

