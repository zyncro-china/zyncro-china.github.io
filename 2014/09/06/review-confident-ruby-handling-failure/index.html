<html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
<title>review confident ruby(handling failure)</title>
<meta content='' name='description'>
<meta content='width=device-width' name='viewport'>
<link href='/css/normalize.css' rel='stylesheet'>
<link href='/css/main.css' rel='stylesheet'>
<link href='/css/bootstrap.min.css' rel='stylesheet'>
<link href='/stylesheets/background.css' rel='stylesheet'>
<link href='/stylesheets/article.css' rel='stylesheet'>
<script src='/js/vendor/modernizr-2.6.1.min.js'></script>
<script src='/js/vendor/jquery-1.8.0.min.js'></script>
<script src='/js/bootstrap.min.js'></script>
<link href="/stylesheets/rouge.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/home.css" media="screen" rel="stylesheet" type="text/css" />
</head>
<body>
<header>
<nav class='navbar navbar-default' role='navigation'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-ex1-collapse' data-toggle='collapse' type='button'>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</button>
<a class='navbar-brand'></a>
</div>
<div class='collapse navbar-collapse navbar-ex1-collapse'>
<ul class='nav navbar-nav'>
<li>
<a href='/'>Home</a>
</li>
<li>
<a href='/feed.xml'>Feed</a>
</li>
<li>
<a href='/about'>About</a>
</li>
</ul>
</div>
</nav>
</header>
<section class='main'>
<div id='main' role='main'>
<div class='container'>
<article>
<div class='title'>
<h1 class='page-header text-center'>
review confident ruby(handling failure)
</h1>
</div>
<br>
<h2>介绍 Handling Failure</h2>

<p>自信地处理错误情况。这本书只讨论BRE(begin/rescue/end) block,因为BRE在代码里是如此醒目,
会把注意力引离method要做的事，所以需要想办法不要让它出现在程序的主要逻辑里。</p>

<h2>Handling Failure的模式</h2>

<ol>
<li>Prefer top-level rescue clause</li>
<li>Use checked methods for risky operations</li>
<li>Use bouncer methods</li>
</ol>

<h3>Prefer top-level rescue clause</h3>

<p>当代码里有begin/rescue/end block时，应尽量使用top level的形式,
这样可以清晰地划分出happy path和错误处理部分。</p>
<pre class="highlight ruby">
<span class="k">def </span><span class="nf">bar</span>
  <span class="c1"># happy path goes up here</span>
<span class="k">rescue</span> <span class="c1">#---------------------------</span>
  <span class="c1"># failure scenarios go down here</span>
<span class="k">end</span>

</pre>
<h3>Use checked methods for risky operations</h3>

<p>如果一个method里包含需要处理从lib或system
call的调用出现的错误，那么应该单独写一个函数把它包住,并处理可能出现的异常，这样可以避免重复处理底层的异常</p>
<pre class="highlight ruby"><span class="k">def </span><span class="nf">filter_through_pipe</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
  <span class="n">results</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="no">IO</span><span class="nf">.popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">process</span><span class="o">|</span>
    <span class="n">results</span> <span class="o">=</span> <span class="k">begin</span>
      <span class="n">process</span><span class="nf">.write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
      <span class="n">process</span><span class="nf">.close_write</span>
      <span class="n">process</span><span class="nf">.read</span>
    <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">EPIPE</span>
      <span class="n">message</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">results</span>
<span class="k">end</span>
</pre>
<p>可以用&quot;Receive policies instead of data&quot;模式重构为</p>
<pre class="highlight ruby"><span class="k">def </span><span class="nf">checked_popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">error_policy</span><span class="o">=-&gt;</span><span class="p">{</span><span class="k">raise</span><span class="p">})</span>
  <span class="no">IO</span><span class="nf">.popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">process</span><span class="o">|</span>
    <span class="k">return</span> <span class="k">yield</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">EPIPE</span>
  <span class="n">error_policy</span><span class="nf">.call</span>
<span class="k">end</span>

<span class="k">def </span><span class="nf">filter_through_pipe</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
  <span class="n">checked_popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span><span class="n">message</span><span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">process</span><span class="o">|</span>
    <span class="n">process</span><span class="nf">.write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">process</span><span class="nf">.close_write</span>
    <span class="n">process</span><span class="nf">.read</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre>
<h3>Use bouncer methods</h3>

</article>
<div id="disqus_thread"></div>
            <script type="text/javascript">
            //<![CDATA[
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//zyncrochinadevblog.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            //]]>
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </script>

</div>
</div>
</section>
<footer>
<script type="text/javascript">
//<![CDATA[
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44086232-1', 'zyncro-china.com');
  ga('send', 'pageview');
//]]>
</script>
</footer>
</body>
</html>

